<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<script src="http://code.jquery.com/jquery-2.1.0.min.js" type="text/javascript"></script>
		<script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
		<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB7g1sf3vXgSCDBk7MPVjlUNGhaTBukXyk&sensor=true" type="text/javascript"></script>
		<script type="text/javascript">
			var map;
			var markers = [];
			var password_validate = false;
			var captcha = false;
			var user = false;

			function initialize() {
				var mapOptions = {
					center : new google.maps.LatLng(51, 7),
					zoom : 8
				};
				map = new google.maps.Map($("#map")[0], mapOptions);
			}


			google.maps.event.addDomListener(window, 'load', initialize);
			function clearAllMarkers() {
				if (markers) {
					for (i in markers) {
						markers[i].setMap(null);
					}
					markers.length = 0;
				}
			}

			function addMarker(marker) {
				this.markers.push(marker);
			}

			function addUser(form) {
				console.log(user.toString());
				console.log(password_validate.toString());
				console.log(captcha.toString());
				if (user && password_validate && captcha) {

					$.ajax({
						url : 'http://localhost/FAPServer/addUser',
						type : 'POST',
						dataType : 'json',
						contentType : 'application/json',
						data : JSON.stringify({
							'loginName' : $('#username').val(),
							'passwort' : {
								'passwort' : $('#password').val()
							},
							'vorname' : $('#surname').val(),
							'nachname' : $('#name').val(),
							'strasse' : $('#street').val(),
							'plz' : $('#postal').val(),
							'ort' : $('#city').val(),
							'land' : $('#country').val(),
							'telefon' : '012345678979',
							'email' : {
								'adresse' : $('#mail').val()
							}
						}),
						success : function(data) {
							if (data) {
								alert('User erfolgreich angelegt');
							} else {
								alert('User nicht erfolgreich angelegt');
							}
						}
					});
				} else {
					if (!user) {
						alert('Benutzer nicht verfügbar');
					} else if (!password_validate) {
						alert('Passwörter stimmen nicht überein');
					} else if (!captcha) {
						alert('Captcha Eingabe ist falsch');
					}
				};
			}
		</script>
		<link rel="stylesheet" type="text/css" href="../css/register.css"/>
		<title>register</title>
	</head>
	<body>
		<header>

		</header>

		<div id="main">
			<form name="add_User" accept-charset="utf-8">
				<fieldset>
					<section style="display: block">
						<label for="surname">Vorname: </label>
						<input id="surname" name="surname" type="text" required/>

						<label for="name">Nachname: </label>
						<input id="name" name="name" type="text" required/>
					</section>
					<section id="personal" style="display: block">
						<label for="username">Gew&uuml;nschter
							<br>
							Benutzername: </label>
						<input id="username" name="username" type="text" required/>
						<div id='check' style="display:inline"></div>
						<script type="text/javascript">
							$('#username').keyup(function() {
								$.ajax({
									url : 'http://localhost/FAPServer/checkLoginName',
									dataType : 'json',
									contentType : 'application/json',
									data : {
										id : $('#username').val()
									},
									error : function(xhr, status) {
										console.log(status);
									},
									success : function(data) {
										console.log('success');
										if (data) {
											$('#check').text('Benutzername nicht verfügbar');
											user = false;
										} else {
											$('#check').text('Benutzername verfügbar');
											user = true;
										}
									}
								});
								console.log('fertig');

							});
						</script>
					</section>
					<section id="credentials" style="display: block">
						<label for="password">Passwort: </label>
						<input id="password" name="password" type="password" maxlength="20" required/>
						<input id="password_check" name="password_check" type="password" maxlength="20" required/>
						<div id="password_validate" style="display:inline"></div>
						<script type="text/javascript">
							$('#password_check').keyup(function() {
								var password = $('#password').val();
								var password_check = $('#password_check').val();
								if (password == password_check) {
									$('#password_validate').text('Passwörter stimmen überein');
									password_validate = true;
								} else {
									$('#password_validate').text('Passwörter stimmen nicht überein');
									password_validate = false;
								};
							});

							$('#password').keyup(function() {

								var password_check = $('#password_check').val();
								var password = $('#password').val();

								if (password == password_check) {
									$('#password_validate').text('Passwörter stimmen überein');
									password_validate = true;
								} else {
									$('#password_validate').text('Passwörter stimmen nicht überein');
									password_validate = false;
								}
								;
							});
						</script>
					</section>
					<section id="location" style="display: block">
						<p>
							<label for="postal">PLZ: </label>
							<input id="postal" name="postal" type="text" pattern="[0-9]{5}"/>
							<script type="text/javascript">
								$('#postal').keyup(function() {
									$.ajax({
										url : 'http://api.geonames.org/postalCodeSearchJSON?username=Babbafett',
										dataType : 'jsonp',
										data : {
											postalcode : $('#postal').val(),
											style : 'full',
											maxRows : 12,
											lang : 'de'
										},
										success : function(data) {
											$('#city').val(data.postalCodes[0].placeName);
											$.ajax({
												url : 'http://api.geonames.org/searchJSON?username=Babbafett',
												dataType : 'jsonp',
												data : {
													name_equals : $('#city').val(),
													featureClass : 'P',
													style : 'full',
													country : 'DE',
													maxRows : 12,
													lang : 'de'
												},
												success : function(data) {
													$('#country').val(data.geonames[0].countryName);
													var latlng = new google.maps.LatLng(data.geonames[0].lat, data.geonames[0].lng);
													map.setZoom(13);
													map.setCenter(latlng);
													clearAllMarkers();
													addMarker(new google.maps.Marker({
														map : map,
														position : latlng
													}));

												}
											});
										}
									});

								});
							</script>

							<label for="city">Ort: </label>
							<input id="city" name="city" type="text" required/>
							<script type="text/javascript">
								$('#city').keyup(function() {
									$.ajax({
										url : 'http://api.geonames.org/searchJSON?username=Babbafett',
										dataType : 'jsonp',
										data : {
											name_equals : $('#city').val(),
											featureClass : 'P',
											style : 'full',
											country : 'DE',
											maxRows : 12,
											lang : 'de'
										},
										success : function(data) {
											$('#country').val(data.geonames[0].countryName);
											var latlng = new google.maps.LatLng(data.geonames[0].lat, data.geonames[0].lng);
											map.setZoom(13);
											map.setCenter(latlng);
											clearAllMarkers();
											addMarker(new google.maps.Marker({
												map : map,
												position : latlng
											}));

										}
									});

								});
							</script>
						</p>

						<p>
							<label for="street">Strasse: </label>
							<input id="street" name="street" type="text" required/>
							<script type="text/javascript">
								var geocoder;
								$('#street').keyup(function() {
									geocoder = new google.maps.Geocoder();
									geocoder.geocode({
										'address' : $('#street').val()
									}, function(results, status) {
										if (status == google.maps.GeocoderStatus.OK) {
											map.setZoom(15);
											map.setCenter(results[0].geometry.location);
											clearAllMarkers();
											addMarker(new google.maps.Marker({
												map : map,
												position : results[0].geometry.location
											}));
											$('#city').val(results[0].address_components[4].long_name);
											$('#country').val(results[0].address_components[7].long_name);
											$('#postal').val(results[0].address_components[8].long_name);
										}
									});
								});
							</script>

							<label for="country">Land: </label>
							<input id="country" name="country" type="text" required/>
						</p>
						<div id="map" style="width: 500px; height: 400px"></div>
					</section>
					<section id="communication" style="display: block">
						<label for="mail">E-Mail: </label>
						<input id="mail" name="mail" type="email" required/>
					</section>
					<section id="captcha_validate" style="display: block">
						<label id="captcha_label" for="captcha"></label>
						<input id="captcha" name="captcha" type="text" pattern="[0-9]{2}" required/>
						<div id='check_captcha' style="display:inline"></div>
						<script type="text/javascript">
							var result;
							$(document).ready(function() {
								var numberA = 1 + Math.floor(Math.random() * 10);
								var numberB = 1 + Math.floor(Math.random() * 10);
								result = numberA + numberB;
								$('#captcha_label').text(numberA.toString() + ' + ' + numberB.toString() + ' = ?');
							});
							$('#captcha').keyup(function() {
								var input = $('#captcha').val();
								if (result == input) {
									$('#check_captcha').text('richtig');
									captcha = true;
								} else {
									$('#check_captcha').text('falsch');
									captcha = false;
								};
							});
						</script>
					</section>
					<section id="ui" style="display: block">
						<input type="button" name="submit" value="OK" onclick="addUser(add_User)"/>
						<input type="submit" value="Abbrechen" />
					</section>
				</fieldset>

			</form>
		</div>

		<footer>

		</footer>
	</body>
</html>